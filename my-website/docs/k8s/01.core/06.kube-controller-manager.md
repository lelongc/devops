## 1. `kube-controller-manager` - "Bá»™ nÃ£o" Äiá»u hÃ nh cá»§a Kubernetes ğŸ§ 

HÃ£y tiáº¿p tá»¥c vá»›i phÃ©p so sÃ¡nh vá» háº¡m Ä‘á»™i tÃ u. Náº¿u `kube-api-server` lÃ  "tá»•ng Ä‘Ã i" trung tÃ¢m, thÃ¬ **`kube-controller-manager`** giá»‘ng nhÆ° lÃ  **táº­p há»£p cÃ¡c phÃ²ng ban chuyÃªn trÃ¡ch** trÃªn tÃ u chá»‰ huy. Má»—i phÃ²ng ban (má»—i "controller") cÃ³ má»™t nhiá»‡m vá»¥ riÃªng vÃ  lÃ m viá»‡c khÃ´ng ngá»«ng nghá»‰.

Vá» cÆ¡ báº£n, `kube-controller-manager` lÃ  má»™t tiáº¿n trÃ¬nh (process) duy nháº¥t, nhÆ°ng bÃªn trong nÃ³ láº¡i chá»©a vÃ  quáº£n lÃ½ ráº¥t nhiá»u controller khÃ¡c nhau.

---

## 2. Controller lÃ  gÃ¬? (VÃ²ng láº·p Äá»‘i chiáº¿u) ğŸ”„

ÄÃ¢y lÃ  khÃ¡i niá»‡m cá»‘t lÃµi báº¡n cáº§n náº¯m:

Má»™t **controller** trong Kubernetes lÃ  má»™t tiáº¿n trÃ¬nh liÃªn tá»¥c thá»±c hiá»‡n má»™t **vÃ²ng láº·p Ä‘iá»u khiá»ƒn (control loop)**:

1. **Theo dÃµi (Watch):** NÃ³ liÃªn tá»¥c theo dÃµi tráº¡ng thÃ¡i cá»§a má»™t loáº¡i tÃ i nguyÃªn nÃ o Ä‘Ã³ trong cá»¥m (thÃ´ng qua `kube-api-server`).
2. **Äá»‘i chiáº¿u (Reconcile):** NÃ³ so sÃ¡nh **tráº¡ng thÃ¡i hiá»‡n táº¡i (current state)** vá»›i **tráº¡ng thÃ¡i mong muá»‘n (desired state)** mÃ  báº¡n Ä‘Ã£ khai bÃ¡o.
3. **HÃ nh Ä‘á»™ng (Act):** Náº¿u hai tráº¡ng thÃ¡i nÃ y khÃ´ng khá»›p nhau, controller sáº½ thá»±c hiá»‡n cÃ¡c hÃ nh Ä‘á»™ng cáº§n thiáº¿t Ä‘á»ƒ Ä‘Æ°a tráº¡ng thÃ¡i hiá»‡n táº¡i vá» gáº§n vá»›i tráº¡ng thÃ¡i mong muá»‘n.

Táº¥t cáº£ "trÃ­ thÃ´ng minh" cá»§a cÃ¡c Ä‘á»‘i tÆ°á»£ng Kubernetes nhÆ° Deployment, Service, Namespace... Ä‘á»u Ä‘Æ°á»£c hiá»‡n thá»±c hÃ³a thÃ´ng qua cÃ¡c controller nÃ y.

---

## 3. CÃ¡c "PhÃ²ng ban" tiÃªu biá»ƒu (VÃ­ dá»¥ vá» Controller)

`kube-controller-manager` quáº£n lÃ½ ráº¥t nhiá»u controller. DÆ°á»›i Ä‘Ã¢y lÃ  hai vÃ­ dá»¥ Ä‘iá»ƒn hÃ¬nh:

### a. Node Controller - "PhÃ²ng Quáº£n lÃ½ Node"

- **Nhiá»‡m vá»¥:** Theo dÃµi "sá»©c khá»e" cá»§a táº¥t cáº£ cÃ¡c Worker Node trong cá»¥m.
- **CÃ¡ch hoáº¡t Ä‘á»™ng:**
  - Cá»© má»—i **5 giÃ¢y**, nÃ³ kiá»ƒm tra tráº¡ng thÃ¡i cá»§a cÃ¡c node.
  - Náº¿u má»™t node khÃ´ng gá»­i "tÃ­n hiá»‡u sá»± sá»‘ng" (heartbeat) vá», controller sáº½ Ä‘á»£i **40 giÃ¢y** rá»“i Ä‘Ã¡nh dáº¥u node Ä‘Ã³ lÃ  `Unreachable`.
  - Sau khi Ä‘Ã¡nh dáº¥u `Unreachable`, nÃ³ cho node Ä‘Ã³ thÃªm **5 phÃºt** Ä‘á»ƒ "há»“i sinh".
  - Náº¿u sau 5 phÃºt mÃ  node váº«n khÃ´ng quay láº¡i, Node Controller sáº½ tiáº¿n hÃ nh **"trá»¥c xuáº¥t" (evict)** cÃ¡c Pod Ä‘ang cháº¡y trÃªn node há»ng Ä‘Ã³ vÃ  yÃªu cáº§u `kube-scheduler` tÃ¬m nhÃ  má»›i cho chÃºng trÃªn cÃ¡c node khá»e máº¡nh khÃ¡c (vá»›i Ä‘iá»u kiá»‡n cÃ¡c Pod Ä‘Ã³ Ä‘Æ°á»£c quáº£n lÃ½ bá»Ÿi má»™t ReplicaSet hoáº·c Deployment).

### b. Replication Controller - "PhÃ²ng Äáº£m báº£o Sá»‘ lÆ°á»£ng"

- **Nhiá»‡m vá»¥:** Äáº£m báº£o sá»‘ lÆ°á»£ng báº£n sao (replicas) cá»§a má»™t Pod luÃ´n Ä‘Ãºng nhÆ° báº¡n Ä‘Ã£ khai bÃ¡o trong Ä‘á»‘i tÆ°á»£ng ReplicaSet.
- **CÃ¡ch hoáº¡t Ä‘á»™ng:**
  - Náº¿u nÃ³ tháº¥y sá»‘ lÆ°á»£ng Pod hiá»‡n táº¡i Ã­t hÆ¡n sá»‘ lÆ°á»£ng mong muá»‘n (vÃ­ dá»¥: má»™t Pod bá»‹ cháº¿t), nÃ³ sáº½ ngay láº­p tá»©c táº¡o ra má»™t Pod má»›i Ä‘á»ƒ bÃ¹ vÃ o.

---

## 4. CÃ i Ä‘áº·t vÃ  Xem Cáº¥u hÃ¬nh

- `kube-controller-manager` lÃ  má»™t file thá»±c thi (binary) duy nháº¥t, chá»©a táº¥t cáº£ cÃ¡c controller bÃªn trong nÃ³.
- **CÃ¡ch xem cÃ¡c tÃ¹y chá»n cáº¥u hÃ¬nh Ä‘ang cháº¡y:**
  - **Vá»›i cá»¥m `kubeadm`:** NÃ³ Ä‘Æ°á»£c triá»ƒn khai nhÆ° má»™t **static Pod** trong namespace `kube-system`. Báº¡n cÃ³ thá»ƒ xem cáº¥u hÃ¬nh trong file manifest cá»§a Pod táº¡i `/etc/kubernetes/manifests/`.
  - **Vá»›i cá»¥m cÃ i thá»§ cÃ´ng:** Xem trong file service táº¡i `/etc/systemd/system/`.
  - **CÃ¡ch chung:** DÃ¹ng lá»‡nh `ps aux | grep kube-controller-manager` trÃªn Master Node Ä‘á»ƒ xem tiáº¿n trÃ¬nh Ä‘ang cháº¡y vÃ  cÃ¡c tham sá»‘ cá»§a nÃ³.
- **TÃ¹y chá»n cáº¥u hÃ¬nh:** Báº¡n cÃ³ thá»ƒ tÃ¹y chá»‰nh hoáº¡t Ä‘á»™ng cá»§a cÃ¡c controller. VÃ­ dá»¥, vá»›i Node Controller, báº¡n cÃ³ thá»ƒ thay Ä‘á»•i cÃ¡c tham sá»‘ thá»i gian nhÆ° `--pod-eviction-timeout`. Báº¡n cÅ©ng cÃ³ thá»ƒ dÃ¹ng cá» `--controllers` Ä‘á»ƒ báº­t/táº¯t má»™t sá»‘ controller cá»¥ thá»ƒ (máº·c Ä‘á»‹nh lÃ  báº­t táº¥t cáº£).

---

## 5. "Chá»‘t háº¡" cho Ká»³ thi CKA ğŸ“

- `kube-controller-manager` lÃ  má»™t **táº­p há»£p cá»§a nhiá»u vÃ²ng láº·p Ä‘iá»u khiá»ƒn (control loops)**.
- Nhiá»‡m vá»¥ chÃ­nh cá»§a nÃ³ lÃ  **theo dÃµi tráº¡ng thÃ¡i cá»§a cá»¥m** thÃ´ng qua API Server vÃ  **thá»±c hiá»‡n cÃ¡c hÃ nh Ä‘á»™ng cáº§n thiáº¿t** Ä‘á»ƒ Ä‘Æ°a tráº¡ng thÃ¡i hiá»‡n táº¡i vá» tráº¡ng thÃ¡i mong muá»‘n.
- Hiá»ƒu rÃµ hoáº¡t Ä‘á»™ng cá»§a cÃ¡c controller tiÃªu biá»ƒu nhÆ° **Node Controller** (vÃ  cÃ¡c má»‘c thá»i gian cá»§a nÃ³) vÃ  **Replication Controller**.
- Biáº¿t cÃ¡ch tÃ¬m file cáº¥u hÃ¬nh cá»§a nÃ³ trong má»™t cá»¥m `kubeadm` (nÃ³ lÃ  má»™t **static Pod**).

`kube-controller-manager` chÃ­nh lÃ  ngÆ°á»i hÃ¹ng tháº§m láº·ng, Ä‘áº£m báº£o cho cá»¥m Kubernetes cá»§a báº¡n luÃ´n hoáº¡t Ä‘á»™ng Ä‘Ãºng nhÆ° nhá»¯ng gÃ¬ báº¡n ká»³ vá»ng. ChÃºc báº¡n má»™t buá»•i chiá»u há»c táº­p hiá»‡u quáº£!

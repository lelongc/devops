"ng∆∞·ªùi h√πng" th·∫ßm l·∫∑ng c·ªßa Kubernetes, gi√∫p ·ª©ng d·ª•ng c·ªßa b·∫°n lu√¥n s·∫µn s√†ng v√† c√≥ th·ªÉ m·ªü r·ªông. ƒê√≥ ch√≠nh l√† **Replication Controller** v√† "h·∫≠u du·ªá" c·ªßa n√≥, **ReplicaSet**.

---

### 1\. T·∫°i sao c·∫ßn "Nh√¢n b·∫£n" (Replication)? ü§î

Trong th·ª±c t·∫ø, vi·ªác ch·ªâ ch·∫°y m·ªôt Pod duy nh·∫•t cho ·ª©ng d·ª•ng c·ªßa b·∫°n r·∫•t r·ªßi ro. Ch√∫ng ta c·∫ßn "nh√¢n b·∫£n" v√¨ hai l√Ω do ch√≠nh:

1. **T√≠nh S·∫µn s√†ng cao (High Availability):**

   - N·∫øu m·ªôt Pod b·ªã l·ªói ho·∫∑c "ch·∫øt", ·ª©ng d·ª•ng c·ªßa b·∫°n s·∫Ω ng·ª´ng ho·∫°t ƒë·ªông.
   - B·∫±ng c√°ch ch·∫°y nhi·ªÅu b·∫£n sao (replicas) c·ªßa Pod, n·∫øu m·ªôt Pod g·∫∑p s·ª± c·ªë, nh·ªØng Pod c√≤n l·∫°i v·∫´n ti·∫øp t·ª•c ph·ª•c v·ª• ng∆∞·ªùi d√πng. Controller s·∫Ω t·ª± ƒë·ªông t·∫°o m·ªôt Pod m·ªõi ƒë·ªÉ thay th·∫ø Pod ƒë√£ h·ªèng.

2. **C√¢n b·∫±ng t·∫£i & M·ªü r·ªông quy m√¥ (Load Balancing & Scaling):**

   - Khi l∆∞·ª£ng ng∆∞·ªùi d√πng tƒÉng l√™n, m·ªôt Pod c√≥ th·ªÉ b·ªã qu√° t·∫£i.
   - B·∫±ng c√°ch t·∫°o th√™m nhi·ªÅu Pod, b·∫°n c√≥ th·ªÉ ph√¢n b·ªï (load balance) l∆∞·ª£ng truy c·∫≠p tr√™n nhi·ªÅu Pod, gi√∫p ·ª©ng d·ª•ng ch·∫°y m∆∞·ª£t m√† h∆°n v√† c√≥ th·ªÉ x·ª≠ l√Ω nhi·ªÅu y√™u c·∫ßu h∆°n.
   - n·∫øu s·ªë l∆∞·ª£ng pod trong 1 node n·∫∑ng qu√° th√¨ n√≥ ƒë∆∞a sang node kh√°c ƒë·ªÉ
     ![1751293004540](image/13.replicaset/1751293004540.png)

---

### 2\. Replication Controller vs. ReplicaSet

C·∫£ hai ƒë·ªÅu c√≥ c√πng m·ª•c ƒë√≠ch: **ƒë·∫£m b·∫£o m·ªôt s·ªë l∆∞·ª£ng Pod nh·∫•t ƒë·ªãnh lu√¥n ch·∫°y**. Tuy nhi√™n:

- **Replication Controller:** L√† c√¥ng ngh·ªá c≈© h∆°n.
- **ReplicaSet:** L√† c√¥ng ngh·ªá m·ªõi h∆°n v√† ƒë∆∞·ª£c **khuy·∫øn kh√≠ch s·ª≠ d·ª•ng**.

Trong b√†i n√†y v√† v·ªÅ sau, ch√∫ng ta s·∫Ω t·∫≠p trung v√†o **ReplicaSet**.

---

### 3\. "Gi·∫£i ph·∫´u" m·ªôt file YAML c·ªßa ReplicaSet üß¨

ƒê·ªÉ t·∫°o m·ªôt ReplicaSet, ch√∫ng ta s·∫Ω ƒë·ªãnh nghƒ©a n√≥ trong m·ªôt file YAML. C·∫•u tr√∫c c·ªßa n√≥ r·∫•t gi·ªëng v·ªõi Pod, nh∆∞ng c√≥ th√™m v√†i ph·∫ßn quan tr·ªçng:

```yaml
apiVersion: apps/v1 # Kh√°c v·ªõi Pod (v1)
kind: ReplicaSet
metadata:
  name: myapp-replicaset
  labels:
    app: myapp
spec:
  replicas: 3 # 1. S·ªë l∆∞·ª£ng b·∫£n sao mong mu·ªën
  selector: # 2. "B·ªô l·ªçc" ƒë·ªÉ t√¨m Pod, B·∫ÆT BU·ªòC
    matchLabels:
      app: myapp
  template: # 3. "Khu√¥n m·∫´u" ƒë·ªÉ t·∫°o Pod m·ªõi
    metadata:
      labels:
        app: myapp
    spec:
      containers:
        - name: nginx-container
          image: nginx
```

H√£y "m·ªï x·∫ª" ph·∫ßn `spec`:

1. **`replicas`**: B·∫°n mu·ªën c√≥ bao nhi√™u b·∫£n sao c·ªßa Pod ƒëang ch·∫°y. Trong v√≠ d·ª• n√†y l√† `3`.
2. **`selector`**: ƒê√¢y l√† ph·∫ßn **c·ª±c k·ª≥ quan tr·ªçng v√† b·∫Øt bu·ªôc** trong ReplicaSet. N√≥ gi√∫p ReplicaSet bi·∫øt ƒë∆∞·ª£c "nh·ªØng Pod n√†o thu·ªôc v·ªÅ m√¨nh".
   - `matchLabels`: ReplicaSet s·∫Ω t√¨m t·∫•t c·∫£ c√°c Pod c√≥ nh√£n (label) kh·ªõp v·ªõi nh·ªØng g√¨ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a match ·ªü ch·ªó template , ph·∫ßn t·∫°o ra pod ·∫•y (trong v√≠ d·ª• l√† `app: myapp`). (l∆∞u √Ω **label g·∫Øn cho ch√≠nh b·∫£n th√¢n ReplicaSet** , gi·ªëng nh∆∞ "tag" ƒë·ªÉ: Nh·∫≠n di·ªán ReplicaSet d·ªÖ h∆°n th√¥i)
3. **`template`**: ƒê√¢y ch√≠nh l√† "khu√¥n m·∫´u" ƒë·ªãnh nghƒ©a Pod. N·∫øu ReplicaSet th·∫•y s·ªë l∆∞·ª£ng Pod hi·ªán t·∫°i √≠t h∆°n `replicas`, n√≥ s·∫Ω d√πng "khu√¥n" n√†y ƒë·ªÉ t·∫°o ra Pod m·ªõi. V·ªÅ c∆° b·∫£n, b·∫°n c√≥ th·ªÉ sao ch√©p ph·∫ßn `metadata` v√† `spec` c·ªßa m·ªôt file ƒë·ªãnh nghƒ©a Pod v√†o ƒë√¢y.

---

### 4\. C∆° ch·∫ø "K·ª≥ di·ªáu" c·ªßa Labels v√† Selectors üè∑Ô∏èüîé

- **Labels (Nh√£n):** L√† c√°c c·∫∑p key-value b·∫°n g·∫Øn v√†o c√°c ƒë·ªëi t∆∞·ª£ng (nh∆∞ Pod) ƒë·ªÉ ph√¢n lo·∫°i ch√∫ng.
- **Selectors (B·ªô ch·ªçn):** L√† c√°ch c√°c ƒë·ªëi t∆∞·ª£ng kh√°c (nh∆∞ ReplicaSet, Service) t√¨m v√† l√†m vi·ªác v·ªõi c√°c ƒë·ªëi t∆∞·ª£ng c√≥ nh√£n t∆∞∆°ng ·ª©ng.

M·ªëi quan h·ªá n√†y l√† "x∆∞∆°ng s·ªëng" c·ªßa Kubernetes. ReplicaSet d√πng `selector` ƒë·ªÉ "qu·∫£n l√Ω" c√°c Pod c√≥ `labels` ph√π h·ª£p.

> **C√¢u h·ªèi hay:** N·∫øu Pod ƒë√£ t·ªìn t·∫°i s·∫µn, ReplicaSet c√≥ c·∫ßn `template` kh√¥ng? **C√ì\!** V√¨ n·∫øu m·ªôt trong c√°c Pod ƒë√≥ b·ªã l·ªói trong t∆∞∆°ng lai, ReplicaSet c·∫ßn `template` ƒë·ªÉ bi·∫øt c√°ch t·∫°o ra m·ªôt Pod m·ªõi thay th·∫ø.

---

### 5\. M·ªü r·ªông quy m√¥ (Scaling) ReplicaSet üìà

Khi b·∫°n mu·ªën thay ƒë·ªïi s·ªë l∆∞·ª£ng replicas (v√≠ d·ª• t·ª´ 3 l√™n 6), c√≥ hai c√°ch ch√≠nh:

1. **C√°ch 1 (Declarative - Khai b√°o):**

   - S·ª≠a gi√° tr·ªã `replicas` trong file YAML (v√≠ d·ª•: `replicas: 6`).
   - Ch·∫°y l·ªánh: `kubectl replace -f <t√™n-file.yaml>`

2. **C√°ch 2 (Imperative - M·ªánh l·ªánh):**

   - D√πng l·ªánh `kubectl scale` tr·ª±c ti·∫øp:

     ```bash
     # C√°ch 1: D√πng t√™n c·ªßa ReplicaSet
     kubectl scale --replicas=6 replicaset myapp-replicaset

     # C√°ch 2: D√πng file ƒë·ªãnh nghƒ©a
     kubectl scale --replicas=6 -f <t√™n-file.yaml>
     ```

   - **L∆∞u √Ω:** C√°ch n√†y ch·ªâ thay ƒë·ªïi tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa ReplicaSet tr√™n c·ª•m, n√≥ **kh√¥ng** c·∫≠p nh·∫≠t l·∫°i file YAML g·ªëc c·ªßa b·∫°n.
   - n·∫øu update image qua edit hay qua file . Mu·ªën c·∫≠p nh·∫≠t, b·∫°n ph·∫£i **x√≥a Pod c≈©** ƒë·ªÉ n√≥ t·∫°o Pod m·ªõi v·ªõi image m·ªõi. qua deployment s·∫Ω x·ªãn h∆°n

---

### 6\. "Ch·ªët h·∫°" cho K·ª≥ thi CKA üìù

- **ReplicaSet** c√≥ nhi·ªám v·ª• duy tr√¨ m·ªôt s·ªë l∆∞·ª£ng Pod ·ªïn ƒë·ªãnh.
- C∆° ch·∫ø c·ªët l√µi l√† s·ª± k·∫øt h·ª£p gi·ªØa **`labels`** (tr√™n Pod) v√† **`selector`** (trong ReplicaSet).
- N·∫Øm v·ªØng c√°c tr∆∞·ªùng b·∫Øt bu·ªôc trong file YAML c·ªßa ReplicaSet: `apiVersion: apps/v1`, `kind: ReplicaSet`, `metadata`, v√† m·ªôt `spec` ch·ª©a **`replicas`**, **`selector`**, v√† **`pod template`**.
- Bi·∫øt c√°ch scale m·ªôt ReplicaSet b·∫±ng c·∫£ `kubectl replace` v√† `kubectl scale`.

---

# ReplicaSet Demo - Detailed Commands and Examples

## 1. View ReplicaSets

### List all ReplicaSets

```bash
kubectl get replicaset
# or short form
kubectl get rs
```

**Output example:**

```
NAME              DESIRED   CURRENT   READY   AGE
new-replica-set   3         3         3       5m
```

### View with more details

```bash
kubectl get rs -o wide
```

**Output example:**

```
NAME              DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES         SELECTOR
new-replica-set   3         3         3       5m    nginx        nginx:1.20     app=nginx
```

## 2. Describe ReplicaSet

```bash
kubectl describe rs new-replica-set
```

**Output example:**

```
Name:         new-replica-set
Namespace:    default
Selector:     app=nginx
Labels:       <none>
Annotations:  <none>
Replicas:     3 desired | 3 updated | 3 total | 3 available | 0 unavailable
Pod Template:
  Labels:  app=nginx
  Containers:
   nginx:
    Image:        nginx:1.20
    Port:         80/TCP
    Host Port:    0/TCP
Events:
  Type    Reason            Age   From                   Message
  ----    ------            ----  ----                   -------
  Normal  SuccessfulCreate  5m    replicaset-controller  Created pod: new-replica-set-abc123
```

## 3. Edit ReplicaSet

### Edit interactively

```bash
kubectl edit rs new-replica-set
```

_This opens the ReplicaSet configuration in your default editor (vi/nano)_

### Apply changes from file

```bash
kubectl apply -f new-replica-set.yml
```

## 4. Scale ReplicaSet

### Scale using file

```bash
kubectl scale --replicas=5 -f new-replica-set.yml
```

### Scale using resource name

```bash
kubectl scale --replicas=5 rs new-replica-set
```

### Verify scaling

```bash
kubectl get rs new-replica-set
kubectl get pods -l app=nginx
```

## 5. Delete ReplicaSet

### Delete ReplicaSet and its pods

```bash
kubectl delete rs new-replica-set
```

### Delete ReplicaSet but keep pods

```bash
kubectl delete rs new-replica-set --cascade=orphan
```

## 6. Complete Demo Workflow

### Step 1: Create ReplicaSet

```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: new-replica-set
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:1.20
          ports:
            - containerPort: 80
```

```bash
kubectl create -f new-replica-set.yml
```

### Step 2: Monitor ReplicaSet

```bash
# Watch ReplicaSet status
kubectl get rs -w

# Check pods created by ReplicaSet
kubectl get pods -l app=nginx

# View detailed information
kubectl describe rs new-replica-set
```

### Step 3: Scale Operations

```bash
# Scale up to 5 replicas
kubectl scale --replicas=5 rs new-replica-set

# Verify scaling
kubectl get rs new-replica-set
kubectl get pods -l app=nginx

# Scale down to 2 replicas
kubectl scale --replicas=2 rs new-replica-set
```

### Step 4: Test Self-Healing

```bash
# Delete a pod to test self-healing
kubectl delete pod <pod-name>

# Watch ReplicaSet recreate the pod
kubectl get pods -l app=nginx -w
```

### Step 5: Cleanup

```bash
kubectl delete rs new-replica-set
```

## 7. Useful Additional Commands

### View ReplicaSet YAML

```bash
kubectl get rs new-replica-set -o yaml
```

### View ReplicaSet JSON

```bash
kubectl get rs new-replica-set -o json
```

### Filter by labels

```bash
kubectl get rs -l app=nginx
```

### View events related to ReplicaSet

```bash
kubectl get events --field-selector involvedObject.name=new-replica-set
```

### Monitor resource usage

```bash
kubectl top pods -l app=nginx
```

## Key Points to Remember

- **ReplicaSet ensures desired number of pods are running**
- **Pods are recreated automatically if deleted**
- **Scaling can be done via file or direct command**
- **Use labels to identify and group related resources**
- **Always verify operations with `kubectl get` commands**
